# üó∫Ô∏è SELENE: ULTIMATE ROADMAP - M√ìDULO DE √ìRDENES (V1.1)

**Objetivo:** Gestionar el ciclo de vida post-pago, automatizar la log√≠stica con Envia.com y administrar las finanzas mediante un sistema de Billetera Interna con Dispersi√≥n Masiva.

---

## FASE 1: INFRAESTRUCTURA DE DATOS Y AUDITOR√çA (SQL)
*Meta: Crear el motor de base de datos que soporte el flujo de dinero y estados.*

1.  **Sincronizaci√≥n de Estados (`OrderStatus`):**
    *   Implementar un tipo `ENUM` en Postgres con los estados: `PAID` (Pagado), `PREPARING` (Gu√≠a generada), `SHIPPED` (En tr√°nsito), `DELIVERED` (Entregado), `COMPLETED` (48h sin disputa, fondos liberados), `DISPUTE` (Venta congelada), `CANCELLED` (Cancelada), `REFUNDED` (Dinero devuelto).
2.  **Sistema de Billetera (Ledger Interno):**
    *   **Tabla `wallets`:** Almacena `pending_balance` (dinero en tr√°nsito) y `available_balance` (dinero listo para retirar).
    *   **Tabla `wallet_transactions`:** **Audit Trail Cr√≠tico**. Cada movimiento de dinero debe registrar: `type` (SALE, PAYOUT, FEE, RELEASE), `amount`, y `balance_after` (el saldo resultante tras la operaci√≥n para evitar auditor√≠as manuales).
3.  **Seguridad RLS:**
    *   Pol√≠ticas estrictas: El vendedor solo tiene acceso de lectura al snapshot de la direcci√≥n del comprador en la tabla `orders` si el estado es `PAID` o superior.

## FASE 2: VISUALIZACI√ìN Y GESTI√ìN (FRONTEND)
*Meta: UI para que el usuario controle sus compras, ventas y dinero.*

1.  **Pantalla "Mis Pedidos" (`OrdersList`):**
    *   Uso de Tabs para separar "Compras" y "Ventas".
    *   Tarjetas con badges de estado din√°micos (colores seg√∫n el `OrderStatus`).
2.  **Pantalla "Detalle de Orden" (`OrderDetail`):**
    *   **Timeline Visual:** Componente vertical que muestra el progreso real del paquete.
    *   **Acciones Contextuales:** Bot√≥n "Generar Gu√≠a" (Vendedor), "Rastrear" (Ambos), "Tuve un problema" (Comprador).
3.  **Pantalla "Mi Billetera" (`WalletScreen`):**
    *   Desglose de saldo y lista de transacciones hist√≥ricas.
    *   Formulario de retiro con **Validaci√≥n de CLABE (18 d√≠gitos)**.

## FASE 3: LOG√çSTICA SEMI-AUTOM√ÅTICA (ENVIA.COM)
*Meta: Generaci√≥n de gu√≠as eficiente sin intervenci√≥n del staff de Selene.*

1.  **Estrategia "Confirmaci√≥n de Disponibilidad":**
    *   La gu√≠a NO se genera sola al comprar. El vendedor debe presionar "Generar Gu√≠a" para confirmar que tiene el paquete listo. Esto evita gastos en gu√≠as que no se usar√°n.
2.  **Edge Function `generate-shipping-label`:**
    *   **Regla Anti-Fraude:** Vendedores novatos (<3 ventas) tienen un l√≠mite de **2 env√≠os activos** simult√°neos. No pueden generar una 3ra gu√≠a hasta que una llegue a su destino.
    *   Llamada a API Envia.com (Estafeta), obtenci√≥n de PDF y actualizaci√≥n de `tracking_number` en la DB.
3.  **Notificaci√≥n:** Env√≠o autom√°tico del PDF de la gu√≠a al correo del vendedor mediante **Resend**.

## FASE 4: AUTOMATIZACI√ìN DEL ESCROW (EL RELOJ)
*Meta: Liberaci√≥n de fondos y auto-cancelaciones sin intervenci√≥n manual.*

1.  **Cron de Tracking (Cada 6 horas):**
    *   Edge Function programada que consulta a Envia.com. Si el paquete dice "Entregado", cambia el estado en Selene a `DELIVERED`.
2.  **Cron de Liberaci√≥n (Escrow de 48h):**
    *   Si una orden lleva 48h en `DELIVERED` y no hay una `DISPUTE` abierta, el sistema mueve autom√°ticamente el dinero de `pending_balance` a `available_balance` y crea el registro en `wallet_transactions`.
3.  **Cron de Auto-Cancelaci√≥n:**
    *   Si el vendedor no genera la gu√≠a en **72 horas** tras el pago, el sistema cancela la orden y dispara un `Refund` autom√°tico en Stripe.

## FASE 5: DISPERSI√ìN MASIVA (ADMIN OPS)
*Meta: Operaci√≥n escalable para el equipo de Selene.*

1.  **Generador de Archivo de Pagos:**
    *   En el panel de Admin, un bot√≥n para exportar todas las solicitudes de retiro `PENDING` a un archivo **CSV/TXT** con el formato exacto que pide el banco (BBVA/Banamex/etc).
2.  **Conciliaci√≥n:**
    *   Una vez subido el archivo al banco, el admin marca el lote como "Pagado" y el sistema notifica a todos los vendedores involucrados.
